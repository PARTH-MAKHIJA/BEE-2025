<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Gatepass System</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    button { padding: 8px 14px; margin: 5px; cursor: pointer; }
    .card { padding: 10px; border: 1px solid #ccc; margin-bottom: 10px; border-radius: 6px; }
    .pending { background: #fff3cd; }
    .approved { background: #d4edda; }
    .rejected { background: #f8d7da; }
  </style>
</head>
<body>

  <h1>Gatepass System</h1>

  <h3>Create Gatepass Request</h3>
  <input id="reason" placeholder="Reason" /> <br><br>
  <input id="fromDate" type="date" /> <br><br>
  <input id="toDate" type="date" /> <br><br>

  <button onclick="createGatepass()">Submit Request</button>

  <hr>

  <h2>My Gatepass Requests</h2>
  <div id="myGatepasses"></div>

  <hr>

  <h2>Pending Requests (Admin/Warden)</h2>
  <div id="pendingGatepasses"></div>

  <script>
    const token = localStorage.getItem("token"); // store token after login

    // WebSocket setup
    const ws = new WebSocket("ws://localhost:3000");

    ws.onopen = () => {
      ws.send(JSON.stringify({ token }));
    };

    ws.onmessage = (msg) => {
      const data = JSON.parse(msg.data);
      if (data.event === "GATEPASS_STATUS" || data.event === "GATEPASS_CREATED") {
        loadMine();
        loadPending();
      }
    };

    async function createGatepass() {
      const res = await fetch("/api/gatepass", {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify({
          reason: document.getElementById("reason").value,
          fromDate: document.getElementById("fromDate").value,
          toDate: document.getElementById("toDate").value
        })
      });

      const data = await res.json();
      alert(data.message);
      loadMine();
      loadPending();
    }

    async function loadMine() {
      const res = await fetch("/api/gatepass/mine", {
        headers: { "Authorization": "Bearer " + token }
      });
      const data = await res.json();
      const container = document.getElementById("myGatepasses");
      container.innerHTML = "";

      data.list.forEach(g => {
        const div = document.createElement("div");
        div.className = `card ${g.status.toLowerCase()}`;
        div.innerHTML = `
          <b>Status:</b> ${g.status}<br>
          <b>Reason:</b> ${g.reason}<br>
          <b>From:</b> ${g.fromDate.substring(0,10)}<br>
          <b>To:</b> ${g.toDate.substring(0,10)}
        `;
        container.appendChild(div);
      });
    }

    async function loadPending() {
      const res = await fetch("/api/gatepass/pending", {
        headers: { "Authorization": "Bearer " + token }
      });

      if (res.status !== 200) return; // student cannot see

      const data = await res.json();
      const container = document.getElementById("pendingGatepasses");
      container.innerHTML = "";

      data.pending.forEach(g => {
        const div = document.createElement("div");
        div.className = "card pending";
        div.innerHTML = `
          <b>Name:</b> ${g.userId.name}<br>
          <b>Reason:</b> ${g.reason}<br>
          <button onclick="approve('${g._id}')">Approve</button>
          <button onclick="rejectPass('${g._id}')">Reject</button>
        `;
        container.appendChild(div);
      });
    }

    async function approve(id) {
      await fetch(`/api/gatepass/${id}/approve`, {
        method: "PATCH",
        headers: { "Authorization": "Bearer " + token }
      });
      loadPending();
      loadMine();
    }

    async function rejectPass(id) {
      await fetch(`/api/gatepass/${id}/reject`, {
        method: "PATCH",
        headers: { "Authorization": "Bearer " + token }
      });
      loadPending();
      loadMine();
    }

    loadMine();
    loadPending();
  </script>
</body>
</html>
